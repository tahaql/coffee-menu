<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Borna Caf√©</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="admin-panel">
        <div class="panel-header">
            <h1 class="panel-title">Admin Panel</h1>
            <button id="logout-btn" class="btn-logout">Logout</button>
        </div>
        
        <div class="admin-sections">
            <div class="admin-section">
                <h2 class="section-title">Add New Item</h2>
                <div id="add-message" class="success-message" style="display: none;"></div>
                <div id="add-error" class="error-message" style="display: none;"></div>
                
                <form id="add-item-form">
                    <div class="form-group">
                        <label for="item-name">Item Name:</label>
                        <input type="text" id="item-name" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-price">Price (Toman):</label>
                        <input type="number" id="item-price" name="price" min="0" step="1000" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-category">Category:</label>
                        <select id="item-category" name="category" required>
                            <option value="">Select Category</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Coffee">Coffee</option>
                            <option value="Tea">Tea</option>
                            <option value="Food">Food</option>
                            <option value="Snacks">Snacks</option>
                            <option value="Desserts">Desserts</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </form>
            </div>
            
            <div class="admin-section">
                <h2 class="section-title">Quick Stats</h2>
                <div id="stats-content">
                    <p>Total Items: <span id="total-items">0</span></p>
                    <p>Categories: <span id="total-categories">0</span></p>
                </div>
            </div>
        </div>
        
        <div class="items-list">
            <h2 class="section-title">Manage Items</h2>
            <div id="items-container">
                <p style="text-align: center; color: #7f8c8d;">Loading items...</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Item</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div id="edit-error" class="error-message" style="display: none;"></div>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <div class="form-group">
                    <label for="edit-name">Item Name:</label>
                    <input type="text" id="edit-name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-price">Price (Toman):</label>
                    <input type="number" id="edit-price" name="price" min="0" step="1000" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-category">Category:</label>
                    <select id="edit-category" name="category" required>
                        <option value="Beverages">Beverages</option>
                        <option value="Coffee">Coffee</option>
                        <option value="Tea">Tea</option>
                        <option value="Food">Food</option>
                        <option value="Snacks">Snacks</option>
                        <option value="Desserts">Desserts</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Update Item</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/admin/status');
                const data = await response.json();
                if (!data.isAdmin) {
                    window.location.href = '/admin';
                }
            } catch (error) {
                window.location.href = '/admin';
            }
        }

        // Load items
        async function loadItems() {
            try {
                const response = await fetch('/api/admin/items');
                const items = await response.json();
                
                const container = document.getElementById('items-container');
                
                if (items.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">No items found.</p>';
                    return;
                }
                
                container.innerHTML = items.map(item => `
                    <div class="item-row">
                        <div class="item-info">
                            <strong>${item.name}</strong><br>
                            <small>${item.category} - ${item.price.toLocaleString()}t</small>
                        </div>
                        <div class="item-actions">
                            <button class="btn-small btn-edit" onclick="editItem('${item._id}', '${item.name}', ${item.price}, '${item.category}')">
                                Edit
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteItem('${item._id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Update stats
                document.getElementById('total-items').textContent = items.length;
                const categories = [...new Set(items.map(item => item.category))];
                document.getElementById('total-categories').textContent = categories.length;
                
            } catch (error) {
                document.getElementById('items-container').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c;">Error loading items.</p>';
            }
        }

        // Add item
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/admin/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('add-message').textContent = 'Item added successfully!';
                    document.getElementById('add-message').style.display = 'block';
                    document.getElementById('add-error').style.display = 'none';
                    e.target.reset();
                    loadItems();
                    
                    setTimeout(() => {
                        document.getElementById('add-message').style.display = 'none';
                    }, 3000);
                } else {
                    document.getElementById('add-error').textContent = result.error;
                    document.getElementById('add-error').style.display = 'block';
                    document.getElementById('add-message').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('add-error').textContent = 'Failed to add item.';
                document.getElementById('add-error').style.display = 'block';
                document.getElementById('add-message').style.display = 'none';
            }
        });

        // Edit item
        function editItem(id, name, price, category) {
            document.getElementById('edit-item-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-price').value = price;
            document.getElementById('edit-category').value = category;
            document.getElementById('edit-modal').style.display = 'block';
            document.getElementById('edit-error').style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // Update item
        document.getElementById('edit-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const id = document.getElementById('edit-item-id').value;
            
            try {
                const response = await fetch(`/api/admin/items/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeEditModal();
                    loadItems();
                } else {
                    document.getElementById('edit-error').textContent = result.error;
                    document.getElementById('edit-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('edit-error').textContent = 'Failed to update item.';
                document.getElementById('edit-error').style.display = 'block';
            }
        });

        // Delete item
        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/items/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadItems();
                } else {
                    alert('Failed to delete item.');
                }
            } catch (error) {
                alert('Failed to delete item.');
            }
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Initialize
        checkAuth();
        loadItems();
    </script>
</body>
</html>